<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Simple Chat Client</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 30px auto; }
    #messages { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; }
    .message { margin-bottom: 10px; }
    .username { font-weight: bold; margin-right: 5px; }
    #inputForm { margin-top: 15px; display: flex; }
    #inputForm input { flex: 1; padding: 8px; font-size: 16px; }
    #inputForm button { padding: 8px 15px; font-size: 16px; }
  </style>
</head>
<body>

<h2>Chat Room: <span id="roomName"></span></h2>

<div id="messages"></div>

<form id="inputForm">
  <input id="messageInput" type="text" placeholder="Type your message..." autocomplete="off" required />
  <button type="submit">Send</button>
</form>

<script>
  const roomId = "general"; 
  const token = "your_jwt_token_here"; // Replace with your actual JWT token

  document.getElementById("roomName").textContent = roomId;

  const messagesDiv = document.getElementById("messages");
  const form = document.getElementById("inputForm");
  const input = document.getElementById("messageInput");

  let oldestTimestamp = null;
  const wsUrl = `ws://localhost:8000/ws/${roomId}?token=${token}`;
  let ws;

  function addMessage(msg) {
    const div = document.createElement("div");
    div.classList.add("message");
    div.innerHTML = `<span class="username">${msg.username}:</span> ${msg.content} <small style="color:#999">${new Date(msg.timestamp).toLocaleTimeString()}</small>`;
    messagesDiv.appendChild(div);
  }

  function connectWebSocket() {
    ws = new WebSocket(wsUrl);

    ws.onopen = () => console.log("Connected to WebSocket");

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      addMessage(msg);
      if (!oldestTimestamp || new Date(msg.timestamp) < new Date(oldestTimestamp)) {
        oldestTimestamp = msg.timestamp;
      }
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    };

    ws.onclose = () => {
      console.log("WebSocket closed. Reconnecting in 3 seconds...");
      setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = (err) => {
      console.error("WebSocket error:", err);
      ws.close();
    };
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    if (ws && ws.readyState === WebSocket.OPEN) {
      const message = input.value.trim();
      if (message) {
        ws.send(JSON.stringify({ content: message }));
        input.value = "";
      }
    }
  });

  messagesDiv.addEventListener("scroll", () => {
    if (messagesDiv.scrollTop === 0 && oldestTimestamp) {
      loadOlderMessages();
    }
  });

  async function loadOlderMessages() {
    try {
      const res = await fetch(`http://localhost:8000/messages/${roomId}?before_timestamp=${encodeURIComponent(oldestTimestamp)}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok) throw new Error("Failed to fetch older messages");
      const olderMessages = await res.json();
      if (olderMessages.length === 0) return;

      olderMessages.reverse().forEach(msg => {
        const div = document.createElement("div");
        div.classList.add("message");
        div.innerHTML = `<span class="username">${msg.username}:</span> ${msg.content} <small style="color:#999">${new Date(msg.timestamp).toLocaleTimeString()}</small>`;
        messagesDiv.insertBefore(div, messagesDiv.firstChild);
      });

      oldestTimestamp = olderMessages[0].timestamp;
      messagesDiv.scrollTop = 10;
    } catch (err) {
      console.error(err);
    }
  }

  connectWebSocket();
</script>

</body>
</html>
